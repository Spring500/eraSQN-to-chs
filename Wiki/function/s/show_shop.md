# @SHOW_SHOP

> [\[回Wiki首页\]](/Wiki) [\[回函数列表\]](/Wiki/function/README.md)

### 作用描述

+ 读取存档后，此函数会被自动执行

### 所在文件

+ [Shop.erb](/ERB/SHOP/Shop.erb#L137-L545)

### 调用关系

**被调用**：

+ 读取存档后，此函数会被自动执行

**调用**：

+ `@VERUP_ERASQN`<sup>[说明文件](/Wiki/function/v/verup_erasqn.md)</sup>

+ `@SETFLAG`<sup>[说明文件](/Wiki/function/s/setflag.md)</sup>

+ `@CHECK_FLAG_MUMA`<sup>[说明文件](/Wiki/function/c/check_flag_muma.md)</sup>

+ `@SET_COUNTER_BASE`

+ `@SAVE_PALAM_BEFORECOM`

+ `@DAYEV`

+ `@EVENT_TRAVEL`

+ `@EVENTTURNEND_FLAG`

+ `@TEXT`

+ `@PRINT_BAR`

+ `@PRINT_DRESS`

+ `@ASSI_LIST_INDICATE`

+ `@ASSI_LIST_ABL`

+ `@CONFIG`

+ `@CHARA_NUM`

+ `@TEXT_LJ`

### 函数实现

#### 参数

+ 无参数

#### 返回值

返回值描述

#### 功能实现

##### 变量表

+ `LINECOUNT` 引擎内置变量

L149：调用`@VERUP_ERASQN`更新旧版存档

L155：判定值设为显示

L157：重置变量TFLAG

L160：CVARSET CFLAG, 95, 0

L162：重置助手显示设定

L164：重置能力显示画面的三围显示

L166：重置变更调教对象画面

L168：重置调教过程中设置的标志，例如角色记录，开放深夜偷吃等

L170：重置调教时的命令过滤器为显示全部命令

L172：重置对象和助手是否可以变更，商店的[101][109][110]三项

L174-L175：将玩家重置为MASTER（以防万一）

L177-L180：VARSET TARGET, 0, 1, 4；TARGET = MAX(TARGET, 0)；ASSI = MAX(ASSI, 0)

L182：检查等级限制器是什么状态

L187：调用`@CHECK_FLAG_MUMA`

L190：调用`@SET_COUNTER_BASE`设置精力和STOCK

L192：调用`@SAVE_PALAM_BEFORECOM`执行调教命令前记录参数？还是说Palam里面所列出的能力？

L197-L217：温泉旅行相关的东西（以后再解读）

L222：用`FLAG:2`记录到目前为止引擎显示过的行数`LINECOUNT`

L228-L230：计算游戏内部的季节和时间

L232：显示游戏内部的季节和时间

L233-L234：如果在酒馆吃过东西，就显示吃过的东西

L236-L238：如果持有魔法瓶，就显示魔法瓶内的精液储量

L240-L253：如果是圣诞节就显示特殊的符号标记（以后再解读）

L255-L265：如果设置了调教对象，就显示调教对象的名字、生理周期、体力、好感度、侍奉快乐经验、穿着

L266-L280：如果设置了助手，就显示助手的名字、生理周期、助手的能力以及给助手的指示

L282：显示MASTER的名字

L283-L299：如果开启了等级限制器，就显示等级限制器的设定

L300：显示MASTER的精力、STOCK、生理周期、能力

L312：VARSET ITEMSALES, 1, 0, 100

L316：设置变量 MENU_SHOP

L318-L324：向变量MENU_SHOP追加菜单项目[进行调教]，如果没有设置调教对象，就将[进行调教]设成灰色，如果设置了调教对象且`GETBIT(CFLAG:201, 4)==1`就显示成[前去会面]，其余情况追加为[进行调教] 。`CFLAG:201`推测是相思相爱或恋慕或淫乱的标志

L326：向变量MENU_SHOP追加菜单项目[查看能力]

L328-L330：向变量MENU_SHOP追加菜单项目[休息]，如果没有设置调教对象或者调教对手不可变更时显示为灰色

L332-L334：向变量MENU_SHOP追加菜单项目[交换助手和对象]，如果没有设置助手或调教对象不可变更是显示为灰色

L336-L338：向变量MENU_SHOP追加菜单项目[变更助手]，如果可以作为助手的人数为0或调教助手不可变更时显示为灰色

L340-L342：向变量MENU_SHOP追加菜单项目[变更调教对象]，如果可以调教的对象人数为0或调教对象不可变更时显示为灰色

L344-L349：向变量MENU_SHOP追加菜单项目[梦魔召唤]，如果角色总数>=100或调教对象不可变更是显示为灰色，如果角色总数<2时显示和为粉红色

L351-L353：向变量MENU_SHOP追加菜单项目[梦魔出售]，如果可以出售的角色为0或调教对手不可变更状态就显示为灰色

L355-L357：向变量MENU_SHOP追加菜单项目[确认着装]，如果角色总数小于2，则显示为灰色

L359：显示水蓝色的菜单项目[呼叫御用商人]

L361-L363：向变量MENU_SHOP追加菜单项目[去高级服饰店]，如果所持衣装数量=总衣装数，则显示为灰色否则显示为水蓝色

L365：向变量MENU_SHOP追加水蓝色菜单项目[去秘法店]

L367：向变量MENU_SHOP追加水蓝色菜单项目[去饰品屋]

L369-L371：向变量MENU_SHOP追加水蓝色菜单项目[去酒馆]，如果之前吃过东西就显示为灰色

L373-L375：向变量MENU_SHOP追加菜单项目[外出许可管理]，如果可以外出的人数不大于0则显示为灰色

L377：向变量MENU_SHOP追加菜单项目[外出探索]

L379-L383：向变量MENU_SHOP追加菜单项目[素材调合]，如果MASTER或者助手都没有持有技能调合知识的话就显示为灰色

L385-L387：向变量MENU_SHOP追加菜单项目[文书工作]，如果没有文书工作可以做或者拥有文书工作技能的角色数为0，则显示为灰色

L389-L391：向变量MENU_SHOP追加菜单项目[助手性欲处理]，如果没有设置助手或助手没有性欲或调教对手不可变更则显示为灰色

L393-L395：向变量MENU_SHOP追加菜单项目[预约旅行]，如果没有设置调教对象或目前不可以去温泉旅行，则显示为灰色

L397-L399：向变量MENU_SHOP追加菜单项目[偏爱&弱点设定]，如果还有限制天数，则显示为灰色

L401-L403：向变量MENU_SHOP追加菜单项目[道具&衣装一览]，如果所持道具数+所持衣装数=0则显示为灰色

L404-L406：向变量MENU_SHOP追加菜单项目[出售道具]，如果可出售道具数=0则显示为灰色

L408-L410：向变量MENU_SHOP追加菜单项目[数据分析]（被关闭），如果没有设置调教对象，这显示为灰色

L412-L418：向变量MENU_SHOP追加菜单项目[咖啡店的准备]或[咖啡店开张]，如果持有的店铺数量>0则显示为准备，否则如果可以运营店铺数为0则显示为开张

L420：向变量MENU_SHOP追加菜单项目[保存]

L422：向变量MENU_SHOP追加菜单项目[读取]

L424-L425：向变量MENU_SHOP追加菜单项目[从梦中醒来]，当`ITEM:化蝶之梦`等于100时

L427-L428：向变量MENU_SHOP追加菜单项目[等级限制器]，如果持有等级限制器时

L430：向变量MENU_SHOP追加菜单项目[系统设定]

L433-L434：向变量MENU_SHOP追加菜单项目[迎接END]，如果满足条件的话

L435-L436：向变量MENU_SHOP追加菜单项目[回想特殊END]，如果"ＥＮＤ閲覧済">0

L438-L439：向变量MENU_SHOP追加菜单项目[给XXX取名字]，如果存在没有命名的子孙时（可能存在翻译bug导致显示不出来，后期需要注意检查）

L442：设置变量LOCALS

L443：将MENU_SHOP以`/`作为分隔符进行分割，将分割结果存到LOCALS中

L449-L475：使用FOR循环遍历LOCALS，并使用`@TEXT_LJ`打印菜单项目，每输出三个就换行一次，此处有中文字符长度bug，日后需要修正

L476-L477：最后再确认一下，如果换行标记为3的倍数，再输出一个换行符