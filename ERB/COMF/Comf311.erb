@COM311
;メルティキッス
;メローナ専用技。相手を恍惚にする。内容的にはアルカナが近い。

PRINTL メルティキッス

CALL TRAIN_MESSAGE_B

SIF REFUSE_CHECK()
	RETURN 0

STR:0 = メルティキッス

RETURN 1

@FLAG_COM311, ARG
;夢魔の口⇔調教者の口の汚れが移動
CALL EQ_STAIN, TARGET, PLAYER, 0, 0

@SOURCE_COM311, ARG
VARSET LOCAL

LOCAL:20 += 20
LOCAL:21 += 100

LOCAL:8 = COM_ORDER_STAIN("Ｍ", "Ｍ")*100 + 100

;上位夢魔の時
IF TALENT:上位梦魔
	LOCAL:13 = 50
;夢魔の時
ELSEIF TALENT:梦魔
	LOCAL:13 = 70
	LOCAL:14 = 5
ELSE
	LOCAL:13 = 100
	LOCAL:14 = 10
ENDIF

;汚れデータを元に、LOCAL:8は上で決定

;情愛のソース
LOCAL:3 = 100

;開幕キスはちょっとボーナス
SIF NUM("ターン数") == 0
	LOCAL:3 += 400
;ABL:Ｍ感觉をみる
LOCAL:18 = CALCF("Ｍ刺激", 1, 120)
;調教者の舌使いをみる
LOCAL:18 = SOURCE_EXABL(LOCAL:18, 30, PLAYER)

;ABL:侍奉精神をみる
SELECTCASE ABL:侍奉精神
CASE 0
	LOCAL:4 = 50
CASE 1
	LOCAL:4 = 150
	LOCAL:5 = 50
CASE 2
	LOCAL:4 = 200
	LOCAL:5 = 100
CASE 3
	LOCAL:4 = 250
	LOCAL:5 = 180
CASE 4
	LOCAL:4 = 300
	LOCAL:5 = 300
CASEELSE
	LOCAL:4 = 350
	LOCAL:5 = 500
ENDSELECT

;ABL:技巧をみる
SELECTCASE ABL:技巧
CASE 0
	TIMES LOCAL:4 , 0.50
	TIMES LOCAL:5 , 0.50
CASE 1
	TIMES LOCAL:4 , 0.80
	TIMES LOCAL:5 , 0.80
CASE 2
CASE 3
	TIMES LOCAL:4 , 1.20
	TIMES LOCAL:5 , 1.20
CASE 4
	TIMES LOCAL:4 , 1.50
	TIMES LOCAL:5 , 1.50
CASEELSE
	TIMES LOCAL:4 , 2.00
	TIMES LOCAL:5 , 2.00
ENDSELECT

CALL CALC, "調教ソース", LOCAL:0, LOCAL:1, LOCAL:2, LOCAL:3, LOCAL:4, LOCAL:5, LOCAL:6, LOCAL:7, LOCAL:8, LOCAL:9, LOCAL:10, LOCAL:11, LOCAL:12, LOCAL:13, LOCAL:14, LOCAL:15, LOCAL:16, LOCAL:17, LOCAL:18, LOCAL:19, LOCAL:20, LOCAL:21, ARG


@TRAIN_MESSAGE_COM311
PRINTFORML %CALLNAME:PLAYER%の蕩ける口づけ！
;ハードスキン状態なら元に戻す。フニャフニャにするかは考え中。
IF STATE("ハードスキン", TARGET)
	CALL REMOVE_STATE, TARGET, "ハードスキン"
	PRINTFORML %CALLNAME:TARGET%は柔らかくなった！
	PRINTFORMW %CALLNAME:TARGET%のハードスキンの効果が切れた！
ELSE
	IF CHECK_COM("メルティキッス", PLAYER)
		PRINTFORMW %CALLNAME:TARGET%は%CALLNAME:PLAYER%にふにゃふにゃにされてしまった！
		CALL ADD_STATE, TARGET, "ふにゃふにゃ"
	ELSE
		PRINTFORMW しかし%CALLNAME:TARGET%には効果がなかった！
	ENDIF
ENDIF

